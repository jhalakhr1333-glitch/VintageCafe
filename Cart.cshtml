@model VintageCafe.Controllers.CartPageViewModel

@{
    ViewData["Title"] = "Your Cart";
    Layout = "_Layout";
}

<div class="container mt-4">
    <h2 class="mb-4">ðŸ›’ Your Cart</h2>

    @if (Model == null || !Model.Items.Any())
    {
        <div class="alert alert-info text-center">
            <h5>Your cart is empty â˜•</h5>
            <a href="/Cafe/Menu" class="btn btn-primary mt-3">Go to Menu</a>
        </div>
    }
    else
    {
        <table class="table table-striped table-bordered align-middle" id="cartTable">
            <thead class="table-dark">
                <tr>
                    <th>Item</th>
                    <th>Price</th>
                    <th>Quantity</th>
                    <th>Line Total</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model.Items)
                {
                    <tr data-id="@item.MenuItem.Id">
                        <td><strong>@item.MenuItem.Name</strong></td>
                        <td>â‚¹@item.MenuItem.Price</td>
                        <td class="qty">@item.Quantity</td>
                        <td class="lineTotal">â‚¹@(item.MenuItem.Price * item.Quantity)</td>
                        <td>
                            <button type="button" class="btn btn-sm btn-success update-cart" data-action="inc">+</button>
                            <button type="button" class="btn btn-sm btn-warning update-cart" data-action="dec">âˆ’</button>
                            <button type="button" class="btn btn-sm btn-danger update-cart" data-action="remove">Remove</button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>

        <div class="d-flex justify-content-between align-items-center mt-4">
            <div>
                <h5>Subtotal: <span id="subtotal">â‚¹@Model.SubTotal</span></h5>
                <h6>GST (5%): <span id="gst">â‚¹@Model.GST</span></h6>
                <h4 class="text-success mt-2">Grand Total: <span id="total">â‚¹@Model.Total</span></h4>
            </div>
            <div>
                <button id="clearCartBtn" class="btn btn-secondary me-2">Clear Cart</button>
            </div>
        </div>
    }
</div>

<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        attachButtonEvents();

        const clearBtn = document.getElementById("clearCartBtn");
        clearBtn?.addEventListener("click", async () => {
            Swal.fire({
                title: "Clear Cart?",
                text: "All items will be removed.",
                icon: "warning",
                showCancelButton: true,
                confirmButtonColor: "#8b5e34",
                cancelButtonColor: "#6c757d",
                confirmButtonText: "Yes, clear it"
            }).then(async (result) => {
                if (result.isConfirmed) {
                    const resp = await fetch("/Cafe/ClearCart", { method: "POST" });
                    const data = await resp.json();
                    if (data.ok) location.reload();
                }
            });
        });
    });

    function attachButtonEvents() {
        document.querySelectorAll(".update-cart").forEach(btn => {
            btn.addEventListener("click", async () => {
                const tr = btn.closest("tr");
                const id = tr.getAttribute("data-id");
                const action = btn.getAttribute("data-action");

                try {
                    const resp = await fetch(`/Cafe/UpdateCartAjax`, {
                        method: "POST",
                        headers: { "Content-Type": "application/x-www-form-urlencoded" },
                        body: `actionType=${action}&id=${id}`
                    });

                    const data = await resp.json();
                    if (data.ok) {
                        const tbody = document.querySelector("#cartTable tbody");
                        tbody.innerHTML = "";

                        if (!data.items || data.items.length === 0) {
                            Swal.fire({
                                icon: "info",
                                title: "Your cart is empty â˜•",
                                confirmButtonColor: "#8b5e34"
                            }).then(() => location.reload());
                            return;
                        }

                        data.items.forEach(item => {
                            tbody.innerHTML += `
                                    <tr data-id="${item.id}">
                                        <td><strong>${item.name}</strong></td>
                                        <td>â‚¹${item.price}</td>
                                        <td class="qty">${item.qty}</td>
                                        <td class="lineTotal">â‚¹${item.lineTotal.toFixed(2)}</td>
                                        <td>
                                            <button type="button" class="btn btn-sm btn-success update-cart" data-action="inc">+</button>
                                            <button type="button" class="btn btn-sm btn-warning update-cart" data-action="dec">âˆ’</button>
                                            <button type="button" class="btn btn-sm btn-danger update-cart" data-action="remove">Remove</button>
                                        </td>
                                    </tr>`;
                        });

                        document.getElementById("subtotal").textContent = "â‚¹" + data.subTotal.toFixed(2);
                        document.getElementById("gst").textContent = "â‚¹" + data.gst.toFixed(2);
                        document.getElementById("total").textContent = "â‚¹" + data.total.toFixed(2);

                        Swal.fire({
                            toast: true,
                            position: "top-end",
                            icon: "success",
                            title: "Cart updated!",
                            showConfirmButton: false,
                            timer: 900
                        });

                        attachButtonEvents();
                    } else {
                        Swal.fire("Error", "Failed to update cart.", "error");
                    }
                } catch {
                    Swal.fire("Error", "Something went wrong.", "error");
                }
            });
        });
    }
</script>

<style>
    h2 {
        color: #5b3a22;
        font-weight: bold;
    }

    table {
        background-color: #fffaf3;
        border-radius: 10px;
    }

    .btn-success {
        background-color: #4CAF50;
        border: none;
    }

        .btn-success:hover {
            background-color: #45a049;
        }

    .btn-warning {
        background-color: #ffc107;
        color: #000;
        border: none;
    }

        .btn-warning:hover {
            background-color: #e0a800;
        }

    .btn-secondary {
        background-color: #8b5e34;
        border: none;
    }

        .btn-secondary:hover {
            background-color: #6b3e26;
        }

    .btn-danger {
        background-color: #dc3545;
        border: none;
    }

        .btn-danger:hover {
            background-color: #c82333;
        }

    .text-success {
        color: #2e7d32 !important;
    }
</style>
